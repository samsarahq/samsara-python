name: Build & Publish Lambda Layer

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: "The version of the SDK that was just released to PyPI"
        required: true
        type: string
  workflow_call:
    inputs:
      sdk_version:
        description: "The version of the SDK that was just released to PyPI"
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
  LAYER_NAME: "ScriptExecutionLambdaSamsaraSDKLayer"
  PYTHON_RUNTIME: "python3.12"
  ARTIFACT_NAME: "python-layer-zip"
  ARTIFACT_FILE: "python-layer.zip"
  MAX_ZIP_BYTES: "50000000"  # 50 MB Lambda limit
  SDK_VERSION: ${{ inputs.sdk_version }}

jobs:
  build:
    name: Build Lambda Layer in Amazon Linux
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Build inside Amazon Linux container
        run: |
          docker run --rm \
            -e SDK_VERSION="${SDK_VERSION}" \
            -e ARTIFACT_FILE="${ARTIFACT_FILE}" \
            -e MAX_ZIP_BYTES="${MAX_ZIP_BYTES}" \
            -v "$PWD":/work -w /work amazonlinux:2023 bash -lc '
            set -euo pipefail
            
            # Validate version format (semver with optional prerelease)
            if [[ ! "${SDK_VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
              echo "Error: Invalid version format: ${SDK_VERSION}"
              echo "Expected semantic version (e.g., 1.2.3 or 1.2.3-beta.1)"
              exit 1
            fi
            echo "Version validated: ${SDK_VERSION}"
            
            dnf -y update --nobest
            dnf install -y ca-certificates
            update-ca-trust
            dnf -y install python3.12-pip zip findutils

            mkdir -p python
            echo "Installing samsara-api==${SDK_VERSION}"
            MAX_RETRIES=5
            DELAY=15
            ATTEMPT=1
            while (( ATTEMPT <= MAX_RETRIES )); do
              echo "pip install attempt $ATTEMPT of $MAX_RETRIES..."
              if python3.12 -m pip install "samsara-api==${SDK_VERSION}" -t python; then
                echo "pip install succeeded on attempt $ATTEMPT."
                break
              fi
              if (( ATTEMPT == MAX_RETRIES )); then
                echo "pip install failed after $MAX_RETRIES attempts."
                exit 1
              fi
              echo "pip install failed, retrying in ${DELAY}s..."
              rm -rf python/*  # Clean up partial install before retry
              sleep "$DELAY"
              ATTEMPT=$((ATTEMPT + 1))
              DELAY=$((DELAY * 2))
            done

            # Clean unnecessary files but keep .dist-info for license/version metadata
            find python -type f -name "*.pyc" -delete
            find python -type d -name "__pycache__" -prune -exec rm -rf {} +
            find python -type d -name "tests" -prune -exec rm -rf {} +
            
            # Create the zip with correct Lambda layer structure (python/ at root)
            zip -r ${ARTIFACT_FILE} python
            BYTES=$(stat -c%s ${ARTIFACT_FILE})
            echo "ZIP size: $BYTES bytes"
            [ "$BYTES" -lt "${MAX_ZIP_BYTES}" ] || { echo "ZIP exceeds 50MB!"; exit 1; }
            
            # Verify the package can be imported
            echo "Verifying package import..."
            PYTHONPATH=python python3.12 -c "import samsara; print(f\"Successfully imported samsara {samsara.__version__}\")"
          '

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_FILE }}

  publish:
    name: Publish to AWS Lambda Layers
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        region: [ us-west-2, eu-west-1, ca-central-1 ]

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: .

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/GithubPythonSdkLayerPublisher
          aws-region: ${{ matrix.region }}

      - name: Publish Lambda Layer
        run: |
          aws lambda publish-layer-version \
            --layer-name "${LAYER_NAME}" \
            --compatible-runtimes "${PYTHON_RUNTIME}" \
            --compatible-architectures x86_64 \
            --zip-file "fileb://${ARTIFACT_FILE}" \
            --description "${{ inputs.sdk_version }}" \
            --region "${{ matrix.region }}"

      - name: Output latest version ARN
        run: |
          aws lambda list-layer-versions \
            --layer-name "${LAYER_NAME}" \
            --max-items 1 \
            --region "${{ matrix.region }}"
